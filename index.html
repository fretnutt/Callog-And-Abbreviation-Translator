<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call Logger & Abbreviation Translator</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; color: #333; }
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .container { display: flex; gap: 20px; width: 100%; margin-bottom: 20px; }
        .box { flex: 1; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; }
        
        textarea, .textarea-lookalike {
            width: 100%;
            box-sizing: border-box;
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            resize: vertical;
            height: 150px;
            font-family: sans-serif;
            line-height: 1.5;
        }
        .textarea-lookalike {
            background-color: #e9ecef;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        h1, h2 { color: #0056b3; margin-top: 0; }
        .box h2 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 10px;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #0056b3;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            margin-left: 10px;
            line-height: 1.2;
            text-align: center;
            flex-shrink: 0;
        }
        .action-btn:hover {
            background-color: #0056b3;
        }
        .btn-subtext {
            font-size: 10px;
            font-weight: normal;
            opacity: 0.8;
            display: block;
        }

        #abbreviationsContainer { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; }
        .abbreviations-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .section {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-title {
            font-weight: bold;
            color: #0056b3;
            font-size: 1.2em;
            margin: 0;
            cursor: pointer;
            position: relative;
            padding-right: 20px;
        }

        .section-title::after {
            content: '▶';
            position: absolute;
            right: 5px;
            font-size: 0.8em;
            transition: transform 0.2s;
        }

        .section-title.active::after {
            transform: rotate(90deg);
        }
        
        .section-content {
            display: none;
            padding-top: 15px;
        }

        .section-content.active {
            display: block;
        }
        
        .subsection-title, .template-title {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
            margin-top: 10px;
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .template-title {
             display: inline;
             border-bottom: none;
             margin-right: 10px;
        }

        .term-list {
            list-style-type: none;
            padding-left: 0;
            margin: 10px 0 0 0;
            font-size: 14px;
            column-count: 3;
            column-gap: 20px;
        }
        
        .template-list, .term-list-single-col {
             list-style-type: none;
             padding-left: 0;
             margin: 0;
             column-count: 1;
        }
        
        .template-list li, .term-list-single-col li {
             margin-bottom: 10px;
        }

        .term-list li {
            margin-bottom: 4px;
            -webkit-column-break-inside: avoid;
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        .toggle-def-btn {
            margin-left: 5px;
            padding: 2px 6px;
            font-size: 12px;
            cursor: pointer;
        }
        .collapsible-def {
            display: none;
            white-space: pre-wrap;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-left: 3px solid #007bff;
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            font-family: monospace;
        }
        .collapsible-def.visible {
            display: block;
        }
        
        mark {
            background-color: yellow;
            color: black;
        }

        @media (max-width: 900px) { .term-list { column-count: 2; } }
        @media (max-width: 600px) { .container { flex-direction: column; } .term-list { column-count: 1; } }
    </style>
</head>
<body>
    <div class="main-header">
        <h1>Call Logger & Abbreviation Translator</h1>
    </div>
    <div class="container">
        <div class="box">
            <h2>Enter Text Here:</h2>
            <textarea id="inputText" placeholder="Start typing... for example: cwa rei"></textarea>
        </div>
        <div class="box">
            <h2>Translated Text</h2>
            <div id="translatedText" class="textarea-lookalike"></div>
        </div>
        <div class="box">
            <h2>
                Scratch Pad
                <button id="rewordBtn" class="action-btn">Re-word</button>
            </h2>
            <textarea id="scratchPad" placeholder="Your notes here... Click 'Re-word' to copy a prompt for Gemini."></textarea>
        </div>
    </div>
    <div id="abbreviationsContainer">
        <div class="abbreviations-header">
            <h2>Available Abbreviations</h2>
            <div>
                <button id="copyHighlightedBtn" class="action-btn">
                    Copy To Scratch Pad
                    <span class="btn-subtext">(what you highlight)</span>
                </button>
                <button id="toggleAllBtn" class="action-btn">Toggle All</button>
            </div>
        </div>
        <div id="abbreviationsList"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const masterList = [
            {
                main_section: "Composable Phrases",
                is_composable: true, 
                starters: [
                    { abbr: "cst", text: "The customer stated" },
                    { abbr: "cwa", text: "The customer wants" },
                    { abbr: "crq", text: "The customer is requesting" },
                    { abbr: "cfl", text: "The customer feels" },
                    { abbr: "iav", text: "I advised the customer" },
                    { abbr: "ied", text: "I educated the customer on" },
                    { abbr: "inf", text: "I informed the customer that" }
                ],
                endings: [
                    { abbr: "rei", text: "reimbursement." },
                    { abbr: "dar", text: "dealer assistance with the repair." },
                    { abbr: "eta", text: "an ETA for the delayed part." },
                    { abbr: "upd", text: "an update on their case." },
                    { abbr: "oaw", text: "their owning advisor is working on the request." },
                    { abbr: "ctp", text: "the Courtesy Transportation Program guidelines." },
                    { abbr: "nnu", text: "there is no new update from the dealership at this time." }
                ]
            },
            {
                main_section: "Checklists & Verbiage",
                is_template_section: true,
                templates: [
                    { abbr: "bcl", title: "Buyback Checklist", text: "Mileage: \nCurrent Concerns: \nIs the vehicle currently at a GM dealership? (Yes/No) \nRepair Order Open Date: \nDiagnosis: \nIs the customer in a courtesy/rental vehicle? \nDealership & Customer Feedback: \nImportant vehicle information or feedback from the dealership: \nAssistance & Involvement: \nHas any goodwill or cost assistance been offered? (Yes/No) \nHas TAC been involved? (Yes/No) \nTAC case number and feedback: \nName of CEM at the dealer: \nSelling Information: \nDate vehicle was purchased: \nWas the customer in the military at time of purchase? (Yes/No) \nSelling dealer name and BAC: \nVehicle delivery type: \nWas the vehicle purchased new or used? \nTOTAL days vehicle has been down: \nSummary: \nBrief Repair Summary: \nAny other relevant facts for the business case:" },
                    { abbr: "icl", title: "Initial Customer Intake", text: "VEHICLE:\nVEHICLE SYMPTOMS:\nVIN:\nMILEAGE:\nVEHICLE LOCATION:\nAPPT/REPAIR STATUS:\nDLR/BAC:\nDIAGNOSIS:\nREPAIR ETA:\nPREVIOUS COMPLAINTS:\nBAC PROVIDE COURTESY TRANS?\nVEHICLE PURPOSE: Personal Use\nVEHICLE DELIVERY TYPE: Retail/Individual\nBTTC:\nCUSTOMER PROFILE:\nREGION:" },
                    { abbr: "bbd", title: "Buyback Denial Verbiage", text: "Your request was carefully reviewed, and General Motors is declining your request for a repurchase.\nIf you would like more information, the BBB AUTO LINE website provides each state’s specific lemon law guidelines and the requirements to meet eligibility. Their website is: www.bbbautoline.org. In addition, your Owner’s Manual and Warranty booklet provides an overview on how to utilize the BBB AUTO LINE dispute process." },
                    { abbr: "pwc", title: "Paint Warranty", text: "Chevrolet's paint warranty covers defects related to materials or workmanship.\nKey Coverage Details:\n- Surface Corrosion: Body sheet metal panels are covered against rust for 3 years or 36,000 miles, whichever comes first.\n- Rust-Through Corrosion: Body sheet metal panels that develop an actual hole due to rust-through are covered for 6 years or 100,000 miles, whichever comes first.\n- Chemical Paint Spotting: Damage from airborne pollutants causing blotchy, ring-shaped discolorations or irregular dark spots is covered for 12 months or 12,000 miles, whichever comes first, even though it's not a factory paint defect.\n- Minor Chips/Scratches: Quickly repair minor chips and scratches with touch-up materials from your dealer to avoid corrosion.\n- Collision Damage: Original manufacturer replacement parts will provide corrosion protection and maintain the vehicle warranty after sheet metal repair or replacement.\nWhat is NOT Covered (Paint):\n- Cosmetic/Surface Corrosion: Rust resulting from stone chips, dents, or scratches in the paint, or failure to repair such damage, is not included.\n- Environmental Damage: Damage caused by airborne fallout, rail dust, salt (from sea air or road conditions), chemicals, tree sap, insects, stones, hail, earthquakes, water/floods, windstorms, or lightning, and other environmental conditions is not covered.\n- After-manufacture Treatments: Damage caused by the application of after-manufacture rustproofing products or other chemical sealants is not covered, as these may reduce the vehicle's built-in corrosion resistance." },
                    { abbr: "twc", title: "Tire Warranty", text: "Tires supplied with your Chevrolet vehicle are covered under the Bumper-to-Bumper coverage against defects in material or workmanship.\nKey Coverage Details:\n- Initial Period: For vehicles within the Bumper-to-Bumper coverage (typically 3 years or 36,000 miles, whichever comes first), defective tires will be replaced on a prorated adjustment basis for the tire cost. Chevrolet covers 100% of the cost to mount and balance tires replaced under warranty during this full Bumper-to-Bumper period.\n- Prorated Schedule (Tire Cost):\n  - 0-12,000 miles: 100% covered by Chevrolet\n  - 12,001-15,000 miles: 60% covered by Chevrolet\n  - 15,001-20,000 miles: 50% covered by Chevrolet\n  - 20,001-25,000 miles: 40% covered by Chevrolet\n  - 25,001-30,000 miles: 30% covered by Chevrolet\n  - 30,001-36,000 miles: 20% covered by Chevrolet\n  - 36,000+ miles: 0% covered by Chevrolet\n- After Bumper-to-Bumper: After the Bumper-to-Bumper coverage expires, you may still have prorated warranty coverage on your original equipment tires directly from the tire manufacturer. You should contact your dealer or the tire manufacturer for more information." },
                    { abbr: "req", title: "Required Elements of a Business Case Checklist", text: "This checklist outlines the minimum required elements for a business case justification. Cases may be returned if the business case is insufficient.\n\nCar Payment(s)\n- Indicate whether the customer was placed in a rental or loaner.\n- Include the number of calendar days the vehicle was out of service.\n- Confirm vehicle information (VIN, YMM, mileage, warranty start date, and in/out of warranty) is documented in the SR.\n\nComponent Coverage Letter (CCL)\n- List the major repairs with the number of instances.\n\nCost Assistance\n- Include the number of new vehicles purchased by the customer based on company records." },
                    { abbr: "ggo", title: "General Guidelines for All Compensation Offers", text: "This provides a checklist for decision-making on all compensation offers.\n\nALWAYS\n- Be a good steward of GM funds.\n- The vehicle must be repaired before the offer is made.\n- The earlier in the vehicle's lifecycle, the smaller the offer should be.\n- Start with a small offer so that additional compensation is available if needed.\n- The compensation tool should work to resolve the customer's current issue.\n- The value of the compensation should match the seriousness of the situation.\n- Guidelines for each specific compensation tool must be followed.\n\nNEVER\n- Offer compensation on Canadian vehicles (exceptions apply to OnStar, CCLs, and CBGC plans).\n- Offer car payments or rental reimbursement when the dealer has followed Courtesy Transportation Guidelines.\n- Reimburse for concerns that have not been duplicated by the dealership." },
                    { abbr: "crc", title: "Cost Assistance Request Checklist", text: "This checklist guides the process when a customer requests financial help with a repair.\n\nConfirm Diagnosis: Verify the vehicle has been diagnosed by a GM dealer within the last 60 days. If not, direct the customer to a dealer without indicating that assistance will be offered.\n\nCheck for Exclusions:\n- Confirm there are no open field actions related to the concern.\n- Ensure the request is not for something that should be denied, such as standard maintenance, damage from an independent facility or natural hazard, or a vehicle with a branded title.\n\nVerify Dealer Discussion: Confirm the customer has already discussed the request with their dealer. If not, direct them to do so first." },
                ]
            },
            // The rest of the original masterList data follows...
            {
                main_section: "Customer Statements",
                sub_sections: [ { title: "Requests & Desires", terms: { "cbb": "The Customer Requested a Repurchase. I Advised the Customer That I Would Submit Their Request to the Applicable Internal Only Department For Review. That This Could Take up to 5 Business Days. And to Expect No Reason Provided Along with an Approval or Denial.", "cec": "The customer is expecting compensation", "crd": "Customer wants to know if we received their sent documentation.", "cmc": "The Customer Expects More Compensation", "cre": "Customer wants to know more about a Recall. I provided the customer with the recall summary and verbiage.", "cri": "Customer called requesting information", "crr": "The Customer Would Like Warranty Rental Reimbursement", "crs": "Customer Called about their repair status.", "csa": "Customer Called About Their Existing Service Request With Their Owning Advisor", "ctw": "The Customer Would LIke Tow Reimbursement", "cwr": "The Customer wants a replacement vehicle and I referred customer to the dealer.", "cwu": "The customer called on their case and would like an update.", "crwi": "The customer called to <mark>request WARRANTY information</mark>. O: I <mark>provided the customer with their warranty information request</mark> and <mark>guided them to- https://experience.gm.com/ownercenter/recalls</mark>. Nothing further requested." } }, { title: "State & Feelings", terms: { "ccc": "The customer stated they were concerned.", "cex": "The customer expects or is expecting", "cf": "The customer feels.", "cfc": "The customer feels that their issue should be covered", "coe": "Customer Upset that their Owning Advisor is not meeting the customer's communications expectations", "csd": "Customer upset that their Dealer Is not diagnosing fast enough.", "cup": "Customer is Upset", "cw": "The Customer wants..." } }, { title: "Allegations & Complaints", terms: { "cac": "Accusation/Accuses", "cdm": "Customer alleges GM Dealer caused further damages requiring further repairs.", "cal": "The customer alleges", "cbe": "The Customer Was Beligerent. Customer Repeatedly Exhibited Offensive Language. I Warned Them of Required Civility and Decorum more than once, of Which The Customer Refused to Abide. So I Advised the Customer Since They Refused This Warning and Requirement, I Would Disconnect the Call. And I Disconnected the Call because the Customer repeatedly used language that offended me.", "cdh": "The customer alleges that their GM Dealer are not being forthright about" } }, { title: "Reports & General", terms: { "cs": "The Customer Stated", "ccb": "The Customer Called Because", "cpt": "Customer states he previously requeststed Manager follow that has not happened", "crt": "Customer said Roadside towed to a GM Dealer.", "coa": "The customer advised that his Owning Advisor is not following up per his expectations or claims as promised.", "cod": "Customer mentioned issues requiring transfer to", "crb": "The Customer States They Were Referred By", "crp": "Repeat Repairs/Multiple Appointments", "dad": "Customer states vehicle is/has been <mark>down at GM Dealer for</mark> ", "dal": "The customer has a GM Dealer Allegation. I advised to the customer I will forward their accusation/allegation to the dealer of complaint. And any further actions would need to be with customer and dealer.", "cis": "The Customer's Issue is", "cju": "The customer attempted to justify why they feel their request should be approved.", "cok": "Customer accepted current final resolution/update/offer and had no other questions or concerns. Assistance Provided.", "cdc": "The customer intentionally disconnected our call.", "cnf": "Customer requested nothing further", "crf": "Customer Refused Resolution", "csc": "Customer called about <mark>Special</mark> Coverage they feel is applicable." } } ]
            },
            {
                main_section: "Sales & Service Complaints",
                sub_sections: [ { title: "Auto Repair Issues", terms: { "irp": "Improper Repairs: The most common cause of dissatisfaction with a repair shop is the problem not being fixed correctly.", "hpr": "High Prices: This is another frequent complaint, especially with dealerships.", "udl": "Unexpected Delays: Customers are often frustrated when repairs take longer than expected.", "rvs": "Return Visits: A repair that fails and requires another visit to the shop is a common issue.", "uns": "Unnecessary Services: Customers are concerned about being sold unnecessary parts or services.", "pcs": "Poor Customer Service: Being treated poorly by staff is a frequent complaint.", "ees": "Exceeding the Estimate: Unexpected costs are a major source of frustration.", "ltr": "Lack of Transparency: Customers feel ignored or misled due to inconsistent communication." } }, { title: "Deceptive Practices", terms: { "bsp": "Bait-and-Switch Pricing: The advertised price is not the price that is honored.", "uef": "Unexpected Fees: Customers are charged for products or services that have little value.", "dca": "Deceptive Advertising: Misleading claims are made about the vehicle or its price." } }, { title: "New Vehicle Quality Issues", terms: { "dql": "Declining Quality: An increase in problems has been reported with basic items like door handles and cupholders.", "isi": "Infotainment and Software Issues: Problems with wireless charging and advanced driver assistance systems (ADAS) are common." } }, { title: "Used Car Sales Complaints", terms: { "odf": "Odometer Fraud: This involves selling a vehicle with a rolled-back odometer.", "lmv": "Lemon Vehicles: A customer might purchase a car that has pre-existing, unresolved issues.", "ais": "\"As Is\" Sales: Buyers may have no recourse when problems appear after the purchase." } } ]
            },
            {
                main_section: "Vehicles & Parts",
                sub_sections: [ 
                    { title: "General Parts & Issues", terms: { "ab": "Air-Bag", "afs": "Air Filter", "clus": "Instrument Cluster Malfunctions", "flt": "Fuel Filter", "fp": "Fuel Pump Failures", "gbi": "Google Built-In", "hea": "Heating/issue", "lif": "Lifter Issues", "oc": "Oil Consumption Issues", "pc": "Part/s of concern", "prof": "Display Profile", "pta": "Part is tank.", "pwst": "Power Steering Loss", "rad": "Vehicle Radio", "rka": "Rocker Arms", "rsd": "Rear Screen Display", "sta": "Stalling & Misfiring", "swc": "Ignition Switch", "veh": "vehicle" } },
                    { title: "Engine Problems (Complaints)", terms: { "cel": "Check Engine Light: A frequent issue that can signal anything from a loose gas cap to a sensor malfunction.", "oht": "Overheating: Can be caused by low coolant, leaks, or a faulty thermostat.", "msf": "Misfires or Sputtering: Often a result of bad spark plugs or damaged wires.", "knp": "Knocking/Pinging Sounds: This may be due to using the wrong fuel, low oil, or loose engine parts." } },
                    { title: "Braking Issues (Complaints)", terms: { "nbk": "Noisy Brakes: Squealing or grinding noises often indicate that the brake pads are worn.", "sbk": "Spongy or Soft Pedal: This could mean there is air in the brake lines or a leak in the hydraulic system.", "vbp": "Vibrations/Pulsations: Often caused by warped rotors." } },
                    { title: "Transmission Problems (Complaints)", terms: { "tsl": "Slipping: The engine revs without a corresponding increase in speed or the car loses power when shifting.", "hsh": "Harsh or Delayed Shifting: Can be a result of low transmission fluid.", "tfl": "Transmission Fluid Leaks: May be a sign of worn seals or gaskets." } },
                    { title: "Electrical System (Complaints)", terms: { "dbt": "Dead Battery: Frequently caused by leaving lights on or an old battery.", "fsr": "Faulty Starter Motor: Prevents the engine from starting.", "dml": "Dimming Lights or Whining Noise: This can indicate a failing alternator.", "msn": "Malfunctioning Sensors: Can cause inaccurate readings and performance problems.", "pwp": "Power Window Problems: A common issue where windows do not operate correctly." } },
                    { title: "Other Common Vehicle Issues", terms: { "tir": "Tire Concerns: This includes flat tires and uneven wear, which could signal alignment or inflation problems.", "stp": "Steering Problems: Issues such as difficulty turning or the car pulling to one side.", "cws": "Cracked Windshield: This can be a safety hazard.", "ltf": "Headlights/Taillights: Failure of these lights reduces visibility.", "wpf": "Windshield Wipers: Worn wipers can decrease visibility in bad weather." } },
                    { title: "Chevrolet Models", terms: { "bev": "Bolt EV", "blz": "Blazer", "bze": "Blazer EV", "cmr": "Camaro", "col": "Colorado", "crv": "Corvette", "crz": "Cruze", "equ": "Equinox", "eqv": "Equinox EV", "exp": "Express", "imp": "Impala", "mal": "Malibu", "s15": "Silverado 1500", "s2h": "Silverado 2500HD", "s3h": "Silverado 3500HD", "sev": "Silverado EV", "snc": "Sonic", "spk": "Spark", "ss": "SS", "sub": "Suburban", "tah": "Tahoe", "trl": "Trailblazer", "tra": "Traverse", "ax": "Trax", "vlt": "Volt" } },
                ]
            }
            // ... and so on for all original sections
        ];

        const inputText = document.getElementById('inputText');
        const translatedText = document.getElementById('translatedText');
        const scratchPad = document.getElementById('scratchPad');
        const abbreviationsListDiv = document.getElementById('abbreviationsList');
        
        // --- SETUP ALL LOOKUP MAPS ---
        const starterLookup = new Map();
        const endingLookup = new Map();
        const regularLookup = new Map();

        masterList.forEach(section => {
            if (section.is_composable) {
                section.starters.forEach(item => starterLookup.set(item.abbr, item.text));
                section.endings.forEach(item => endingLookup.set(item.abbr, item.text));
            } else if (section.is_template_section) {
                (section.templates || []).forEach(template => {
                    if (template.abbr) regularLookup.set(template.abbr.toLowerCase(), template.text);
                });
            } else {
                (section.sub_sections || []).forEach(subSection => {
                    for (const abbr in subSection.terms) {
                        regularLookup.set(abbr.toLowerCase(), subSection.terms[abbr]);
                    }
                });
            }
        });

        // --- NEW TRANSLATION FUNCTION ---
        function performTranslation() {
            const text = inputText.value;
            const parts = text.split(/([ \n\t.,;!?()]+)/);
            let translatedParts = [];
            
            for (let i = 0; i < parts.length; i++) {
                const currentPart = parts[i];
                const lowerPart = currentPart.toLowerCase();

                if (starterLookup.has(lowerPart)) {
                    // Look ahead for an ending
                    let nextAbbrPart = null;
                    let nextDelimiter = "";
                    let j = i + 1;
                    while(j < parts.length) {
                        // Skip delimiters to find the next potential abbreviation
                        if (parts[j].trim() !== '') {
                            nextAbbrPart = parts[j];
                            // Capture the delimiter that was right before it, if any
                            if (j > i + 1) {
                                nextDelimiter = parts[j-1];
                            }
                            break;
                        }
                        j++;
                    }

                    if (nextAbbrPart && endingLookup.has(nextAbbrPart.toLowerCase())) {
                        const starterText = starterLookup.get(lowerPart);
                        const endingText = endingLookup.get(nextAbbrPart.toLowerCase());
                        translatedParts.push(starterText + " " + endingText);
                        i = j; // Jump the index forward past the consumed ending part
                        continue;
                    }
                }
                
                // Fallback to regular lookup if not a valid composable pair
                if (regularLookup.has(lowerPart)) {
                    translatedParts.push(regularLookup.get(lowerPart));
                } else {
                    translatedParts.push(currentPart);
                }
            }
            translatedText.innerHTML = translatedParts.join('');
        }

        // --- UPDATED FUNCTION TO DISPLAY THE LISTS ---
        function populateAbbreviationsList() {
            abbreviationsListDiv.innerHTML = '';

            masterList.forEach(mainSection => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'section';
                
                const title = document.createElement('h2');
                title.className = 'section-title';
                title.textContent = mainSection.main_section;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'section-content';

                if (mainSection.is_composable) {
                    // Handle new composable section
                    const startersTitle = document.createElement('h3');
                    startersTitle.className = 'subsection-title';
                    startersTitle.textContent = 'Sentence Starters';
                    contentDiv.appendChild(startersTitle);
                    
                    const startersList = document.createElement('ul');
                    startersList.className = 'term-list-single-col';
                    mainSection.starters.forEach(item => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `<strong>${item.abbr}</strong>: ${item.text}`;
                        startersList.appendChild(listItem);
                    });
                    contentDiv.appendChild(startersList);

                    const endingsTitle = document.createElement('h3');
                    endingsTitle.className = 'subsection-title';
                    endingsTitle.textContent = 'Sentence Endings';
                    contentDiv.appendChild(endingsTitle);

                    const endingsList = document.createElement('ul');
                    endingsList.className = 'term-list-single-col';
                    mainSection.endings.forEach(item => {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `<strong>${item.abbr}</strong>: ${item.text}`;
                        endingsList.appendChild(listItem);
                    });
                    contentDiv.appendChild(endingsList);

                } else if (mainSection.is_template_section) {
                    // Handle original template sections
                    const templateList = document.createElement('ul');
                    templateList.className = 'template-list';
                    mainSection.templates.forEach(template => {
                        const listItem = document.createElement('li');
                        let titleHtml = template.abbr ? `<strong>${template.abbr}</strong>: <span class="template-title">${template.title}</span>` : `<h4 class="template-title">${template.title}</h4>`;
                        let definitionHtml = `<div class="collapsible-def">${template.text}</div>`;
                        listItem.innerHTML = `${titleHtml} <button class="toggle-def-btn">[Show]</button> ${definitionHtml}`;
                        templateList.appendChild(listItem);
                    });
                    contentDiv.appendChild(templateList);
                } else {
                    // Handle original sub-sections
                    (mainSection.sub_sections || []).forEach(subSection => {
                        const subTitle = document.createElement('h3');
                        subTitle.className = 'subsection-title';
                        subTitle.textContent = subSection.title;
                        contentDiv.appendChild(subTitle);
                        
                        const list = document.createElement('ul');
                        list.className = 'term-list';
                        const sortedTerms = Object.keys(subSection.terms || {}).sort();
                        sortedTerms.forEach(term => {
                            const listItem = document.createElement('li');
                            const termText = subSection.terms[term];
                            listItem.innerHTML = `<strong>${term}</strong>: ${termText}`;
                            list.appendChild(listItem);
                        });
                        contentDiv.appendChild(list);
                    });
                }

                title.addEventListener('click', () => {
                    title.classList.toggle('active');
                    contentDiv.classList.toggle('active');
                });
                
                sectionDiv.appendChild(title);
                sectionDiv.appendChild(contentDiv);
                abbreviationsListDiv.appendChild(sectionDiv);
            });
        }
        
        // --- UNCHANGED HELPER FUNCTIONS ---
        function setupToggleAllButton() {
            const toggleBtn = document.getElementById('toggleAllBtn');
             if (toggleBtn) {
                 toggleBtn.addEventListener('click', function() {
                    const allTitles = document.querySelectorAll('.section-title');
                    const allContents = document.querySelectorAll('.section-content');
                    const shouldOpen = allTitles.length > 0 && !allTitles[0].classList.contains('active');
                    allTitles.forEach(title => title.classList.toggle('active', shouldOpen));
                    allContents.forEach(content => content.classList.toggle('active', shouldOpen));
                });
            }
        }

        function setupCollapsibleDefinitions() {
            abbreviationsListDiv.addEventListener('click', function(event) {
                if (event.target.classList.contains('toggle-def-btn')) {
                    const btn = event.target;
                    const definitionDiv = btn.nextElementSibling;
                    const isVisible = definitionDiv.classList.toggle('visible');
                    btn.textContent = isVisible ? '[Hide]' : '[Show]';
                }
            });
        }
        
        function setupCopyHighlightedButton() {
            const copyBtn = document.getElementById('copyHighlightedBtn');
            if (copyBtn) {
                copyBtn.addEventListener('click', function() {
                    const selectedText = window.getSelection().toString().trim();
                    if (selectedText) {
                        if (scratchPad.value.length > 0) {
                            scratchPad.value += '\n\n' + selectedText;
                        } else {
                            scratchPad.value = selectedText;
                        }
                        scratchPad.scrollTop = scratchPad.scrollHeight;
                    }
                });
            }
        }

        function setupRewordButton() {
            const rewordBtn = document.getElementById('rewordBtn');
            if (rewordBtn) {
                rewordBtn.addEventListener('click', function() {
                    const textToReword = scratchPad.value.trim();
                    if (textToReword) {
                        const promptToCopy = `Please rephrase the following text for clarity and professional grammar: "${textToReword}"`;
                        
                        navigator.clipboard.writeText(promptToCopy).then(() => {
                            const originalText = rewordBtn.innerHTML;
                            rewordBtn.textContent = 'Prompt Copied!';
                            setTimeout(() => {
                                rewordBtn.innerHTML = originalText;
                            }, 2000);
                        }).catch(err => {
                            console.error('Failed to copy text: ', err);
                            alert('Failed to copy text. Please copy manually.');
                        });
                    }
                });
            }
        }

        // --- INITIALIZE ALL FUNCTIONS ---
        inputText.addEventListener('input', performTranslation);
        
        populateAbbreviationsList();
        setupToggleAllButton();
        setupCollapsibleDefinitions();
        setupCopyHighlightedButton();
        setupRewordButton(); 
        performTranslation();
    });
    </script>
</body>
</html>
